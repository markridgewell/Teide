name: Build-and-Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  VULKAN_VERSION: 1.2.198.1
  VULKAN_SDK: ./VULKAN_SDK

jobs:
  windows:
    strategy:
      matrix:
        buildtype: [Debug, Release]
        msvcver: [2019, 2022]

    name: Build-and-Test-Windows-${{matrix.msvcver}}-${{matrix.buildtype}}
    runs-on: windows-${{matrix.msvcver}}

    env:
      CMAKE_BUILD_TYPE: ${{matrix.buildtype}}

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        lfs: true

    - name: Setup Vulkan SDK
      uses: humbletim/setup-vulkan-sdk@v1.2.0
      with:
        vulkan-query-version: ${{env.VULKAN_VERSION}}
        vulkan-components: Vulkan-Headers, Vulkan-Loader
        vulkan-use-cache: true

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v10
      with:
        vcpkgGitCommitId: '0321a8422e786e4c35f3abbc1f03acbcfae35758'

    - name: Setup OpenCppCoverage
      run: |
        choco install OpenCppCoverage -y
        echo "C:\Program Files\OpenCppCoverage" >> $env:GITHUB_PATH

    - name: Download SwiftShader binaries
      uses: robinraju/release-downloader@v1.3
      with:
        repository: "google/gfbuild-swiftshader"
        tag: "github/google/gfbuild-swiftshader/8f075627d16bdd2a8d861e9d81df541f5cf68e2e"
        fileName: "gfbuild-swiftshader-8f075627d16bdd2a8d861e9d81df541f5cf68e2e-Windows_x64_Release.zip"
        out-file-path: "swiftshader"

    - name: Configure CMake
      run: cmake -B ${{github.workspace}}/build --preset msvc${{matrix.msvcver}}

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{matrix.buildtype}}

    - name: Activate SwiftShader
      shell: powershell
      run: |
        Expand-Archive ${{github.workspace}}\swiftshader\*.zip -d ${{github.workspace}}\swiftshader
        Copy-Item ${{github.workspace}}\swiftshader\lib\vulkan-1.dll C:\Windows\System32\

    - name: Test
      working-directory: ${{github.workspace}}/build
      run: python ${{github.workspace}}/tools/coverage.py ci ${{github.workspace}} ${{matrix.buildtype}}

    - name: Upload test log
      if: failure()
      uses: actions/upload-artifact@v2
      with:
        name: TestLog-Windows-${{matrix.buildtype}}
        path: build/Testing/Temporary/LastTest.log

    - name: Upload coverage report
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        fail_ci_if_error: false
        functionalities: fix

    - name: Save coverage report
      uses: actions/upload-artifact@v3
      with:
        name: CoverageReportMSVC${{matrix.msvcver}}${{matrix.buildtype}}
        path: ./coverage.xml

  linux:
    strategy:
      matrix:
        buildtype: [Debug, Release]
        preset: [linux]

    name: Build-and-Test-Linux-${{matrix.buildtype}}
    runs-on: ubuntu-latest

    env:
      CMAKE_BUILD_TYPE: ${{matrix.buildtype}}
      GTEST_FILTER: -SurfaceTest.*
      ASAN_OPTIONS: detect_leaks=0 # Vulkan on Linux appears to leak memory, so disable leak checks

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        lfs: true

    # This step is only needed as long as assimp depends on irrlicht.
    # If the dependency is removed, this step can be removed.
    - name: Install Irrlicht dependencies
      run: |
          sudo apt-get update
          sudo apt install libgl1-mesa-dev libxxf86vm-dev

    - name: Setup Vulkan SDK
      uses: humbletim/setup-vulkan-sdk@v1.2.0
      with:
        vulkan-query-version: ${{env.VULKAN_VERSION}}
        vulkan-components: Vulkan-Headers, Vulkan-Loader
        vulkan-use-cache: true

    - name: Install Irrlicht dependencies
      run: |
          sudo apt-get update
          sudo apt install libgl1-mesa-dev libxxf86vm-dev

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v10
      with:
        vcpkgGitCommitId: '0321a8422e786e4c35f3abbc1f03acbcfae35758'

    - name: Install GCC 11
      run: |
          sudo apt-get update
          sudo apt install gcc-11 g++-11

    - name: Download SwiftShader binaries
      uses: robinraju/release-downloader@v1.3
      with:
        repository: "google/gfbuild-swiftshader"
        tag: "github/google/gfbuild-swiftshader/8f075627d16bdd2a8d861e9d81df541f5cf68e2e"
        fileName: "gfbuild-swiftshader-8f075627d16bdd2a8d861e9d81df541f5cf68e2e-Linux_x64_Release.zip"
        out-file-path: "swiftshader"

    - name: Configure CMake
      run: cmake -B ${{github.workspace}}/build --preset ${{matrix.preset}} -DCMAKE_CXX_COMPILER=g++-11

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{matrix.buildtype}}

    - name: Activate SwiftShader
      run: |
        unzip ${{github.workspace}}/swiftshader/*.zip -d ${{github.workspace}}/swiftshader

    - name: Test
      run: |
        VK_ICD_FILENAMES=${{github.workspace}}/swiftshader/lib/vk_swiftshader_icd.json ctest --test-dir ${{github.workspace}}/build --verbose -C ${{matrix.buildtype}}

    - name: Upload test log
      if: failure()
      uses: actions/upload-artifact@v2
      with:
        name: TestLog-Linux-${{matrix.buildtype}}
        path: Testing/Temporary/LastTest.log
