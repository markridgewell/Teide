name: Build-and-Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  VULKAN_SDK: ./VULKAN_SDK
  VCPKG_OVERLAY_PORTS: ./external/ports

jobs:
  windows:
    strategy:
      fail-fast: false
      matrix:
        buildtype: [Debug, Release]
        preset: [msvc2022, msvc2022-clang]
        include:
        - preset: msvc2022
          runner: windows-2022
          coverage: ON
        - preset: msvc2022-clang
          runner: windows-2022
          coverage: OFF

    name: Windows-${{matrix.buildtype}}-${{matrix.preset}}
    runs-on: ${{matrix.runner}}

    env:
      job_name: Windows-${{matrix.buildtype}}-${{matrix.preset}}
      CMAKE_BUILD_TYPE: ${{matrix.buildtype}}

    steps:
    - name: Print job ID
      run: echo "${{github.job}}"

    - name: Checkout
      uses: actions/checkout@v3
      with:
        lfs: true
        submodules: recursive

    - name: Install dependencies
      uses: ./.github/actions/install-dependencies
      with:
        extra-packages: ${{matrix.coverage == 'ON' && 'OpenCppCoverage' || ''}}

    - name: Configure CMake
      run: cmake --preset ${{matrix.preset}} -DTEIDE_TEST_VERBOSE=ON -DTEIDE_UNIT_TEST_SW_RENDER=ON -DTEIDE_TEST_COVERAGE=${{matrix.coverage}} --trace --trace-format=json-v1 --trace-redirect=CMakeTrace.txt

    - name: Save CMake trace
      uses: actions/upload-artifact@v3
      with:
        name: CMakeTrace-${{env.job_name}}
        path: ./CMakeTrace.txt

    - name: Build
      run: cmake --build --preset ${{matrix.preset}} --config ${{matrix.buildtype}}

    - name: Save CMake output logs
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: CMakeLogs-${{env.job_name}}
        path: |
          ./build/${{matrix.preset}}/**/*.log
          ./external/vcpkg/**/*.log

    - name: Test
      id: test
      run: ctest --preset ${{matrix.preset}} --build-config ${{matrix.buildtype}} --verbose --no-tests=error

    - name: Save render test output
      if: steps.test.outcome == 'failure'
      uses: actions/upload-artifact@v3
      with:
        name: RenderTestOutput-${{env.job_name}}
        path: RenderTestOutput

    - name: Save test log
      if: steps.test.outcome == 'failure'
      uses: actions/upload-artifact@v3
      with:
        name: TestLog-${{env.job_name}}
        path: build/${{matrix.preset}}/Testing/Temporary/LastTest.log

    - name: Upload coverage report
      uses: codecov/codecov-action@v3
      with:
        directory: build/${{matrix.preset}}/coverage/output
        fail_ci_if_error: false
        verbose: true
        functionalities: fixes

    - name: Save coverage report
      uses: actions/upload-artifact@v3
      with:
        name: CoverageReport-${{env.job_name}}
        path: build/${{matrix.preset}}/coverage/output

  linux:
    strategy:
      matrix:
        buildtype: [Debug, Release]
        compiler: [g++-12, clang++-17]
        sanitizer: [OFF]
        include:
        - preset: ninja
        - coverage: OFF
        - buildtype: Debug
          compiler: clang++-17
          coverage: ON
        - buildtype: Debug
          compiler: clang++-17
          sanitizer: ASAN
          preset: ninja
          coverage: OFF
          name-suffix: -asan
        - buildtype: Debug
          compiler: clang++-17
          sanitizer: UBSAN
          preset: ninja
          coverage: OFF
          name-suffix: -ubsan
      fail-fast: false

    name: Linux-${{matrix.buildtype}}-${{matrix.compiler}}${{matrix.name-suffix}}
    runs-on: ubuntu-latest

    env:
      job_name: Linux-${{matrix.buildtype}}-${{matrix.compiler}}${{matrix.name-suffix}}

    steps:
    - name: Print job ID
      run: echo "${{github.job}}"

    - name: Checkout
      uses: actions/checkout@v3
      with:
        lfs: true
        submodules: recursive

    - name: Install dependencies
      uses: ./.github/actions/install-dependencies
      with:
        extra-packages: ninja-build ${{matrix.compiler}}

    - name: Configure CMake
      run: cmake --preset ${{matrix.preset}} -DCMAKE_CXX_COMPILER=${{matrix.compiler}} -DTEIDE_TEST_VERBOSE=ON -DTEIDE_UNIT_TEST_SW_RENDER=ON -DTEIDE_TEST_WINDOWLESS=ON -DTEIDE_TEST_COVERAGE=${{matrix.coverage}} -DTEIDE_SANITIZER=${{matrix.sanitizer}}

    - name: Build
      run: cmake --build --preset ${{matrix.preset}} --config ${{matrix.buildtype}}

    - name: Save CMake output logs
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: CMakeLogs-${{env.job_name}}
        path: |
          ./build/${{matrix.preset}}/**/*.log
          ./external/vcpkg/**/*.log

    - name: Test
      id: test
      run: ctest --preset ${{matrix.preset}} --build-config ${{matrix.buildtype}} --verbose --no-tests=error

    - name: Save render test output
      if: steps.test.outcome == 'failure'
      uses: actions/upload-artifact@v3
      with:
        name: RenderTestOutput-${{env.job_name}}
        path: RenderTestOutput

    - name: Save test log
      if: steps.test.outcome == 'failure'
      uses: actions/upload-artifact@v3
      with:
        name: TestLog-${{env.job_name}}
        path: build/${{matrix.preset}}/Testing/Temporary/LastTest.log

    - name: Upload coverage report
      if: matrix.coverage == 'ON'
      uses: codecov/codecov-action@v3
      with:
        directory: build/${{matrix.preset}}/coverage/output
        fail_ci_if_error: false
        verbose: true
        functionalities: fixes

    - name: Save coverage report
      if: matrix.coverage == 'ON'
      uses: actions/upload-artifact@v3
      with:
        name: CoverageReport-${{env.job_name}}
        path: build/${{matrix.preset}}/coverage/output

  time-report:
    name: Time-Report
    runs-on: ubuntu-latest
    needs: [windows, linux]
    if: ${{ github.event_name == 'push' }}
    env:
      GH_TOKEN: ${{github.token}}

    steps:
    - name: Get workflow run data
      run: |
        echo "Build-and-Test workflow completed, run_id: ${{github.run_id}}"
        echo -n '{"run_data":' > ${{github.sha}}.json
        gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/${{github.repository}}/actions/runs/${{github.run_id}} \
          >> ${{github.sha}}.json
        echo -n ', "job_data":' >> ${{github.sha}}.json
        gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/${{github.repository}}/actions/runs/${{github.run_id}}/jobs \
          >> ${{github.sha}}.json
        echo -n '}' >> ${{github.sha}}.json

    - name: Push workflow run data
      uses: dmnemec/copy_file_to_another_repo_action@v1.1.1
      env:
        API_TOKEN_GITHUB: ${{secrets.API_TOKEN_GITHUB}}
      with:
        source_file: '${{github.sha}}.json'
        destination_repo: '${{github.repository}}Stats'
        destination_folder: 'build_times'
        user_email: '${{github.actor_id}}+${{github.actor}}@users.noreply.github.com'
        user_name: '${{github.actor}}'
        commit_message: 'Add workflow run for commit ${{github.sha}}'
