name: Run-Benchmarks

on:
  workflow_dispatch:
    inputs:
      base-branch:
        description: 'Branch to compare benchmark against'
        required: true
        default: main
        type: string
      repetitions:
        description: 'Number of times to run each benchmark'
        required: true
        default: 10
        type: number

jobs:
  benchmark:
    name: Run-Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        submodules: false

    - name: Install packages
      id: packages
      uses: ./.github/actions/install-packages

    - name: Install dependencies
      uses: ./.github/actions/install-dependencies
      with:
        extra-packages: ninja-build g++-13

    - name: Install google benchmark tools
      run: |
        git clone https://github.com/google/benchmark.git
        python -m pip install -r benchmark/tools/requirements.txt

    - name: Run benchmark script
      run: |
        base_ref=$(git merge-base "${{github.sha}}" "origin/${{inputs.base-branch}}")
        python tools/benchmark.py compare \
          --preset g++-13 \
          --out-dir benchmark_results \
          --out-report report.txt \
          --compare benchmark/tools/compare.py \
          --repetitions ${{inputs.repetitions}} \
          --sw-render \
          -DTEIDE_USE_VCPKG=OFF \
          -DCMAKE_PREFIX_PATH=${{steps.packages.outputs.install-dir}} \
          -DTEIDE_PRECOMPILED_HEADERS=ON \
          "$base_ref" "${{github.sha}}"

    - name: Write PR comment
      env:
        GH_TOKEN: ${{github.token}}
      run: |
        ## Get the ID of the previous comment, if present
        comment_id=$( \
          gh pr view ${{github.ref_name}} \
            --json comments \
            --jq '.comments[] \
              | select(.author.login == "github-actions") \
              | select(.body|startswith("##")) \
              | .url'
          | sed 's/^.*issuecomment-//'

        echo "## Benchmark Report" > comment.md
        echo '```' >> comment.md
        cat report.txt >> comment.md
        echo '```' >> comment.md

        if [[ -z "${comment_id}" ]]; then
          gh pr comment ${{github.ref_name}} --body-file comment.md
        else
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/{owner}/{repo}/issues/comments/${comment_id} \
            -f body=@comment.md
        fi

    - name: Save output
      uses: actions/upload-artifact@v3
      with:
        name: BenchmarkResults
        path: benchmark_results
