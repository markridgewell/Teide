
name: Static-Analysis
on: [push]

jobs:
  cppcheck:
    strategy:
      fail-fast: false
      matrix:
        os: ['Windows', 'Linux']
        include:
          - os: 'Windows'
            runner: 'windows-2022'
            preset: 'msvc2022'
            pkg: 'choco install --ignorepackageexitcodes'
          - os: 'Linux'
            runner: 'ubuntu-latest'
            preset: 'linux'
            pkg: 'sudo apt-get install'

    name: CppCheck-${{matrix.os}}
    runs-on: ${{matrix.runner}}

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install dependencies
      uses: ./.github/actions/install-dependencies
      with:
        preset: ${{matrix.preset}}

    - name: Install CppCheck
      run: ${{matrix.pkg}} cppcheck

    - name: Refresh environment
      if: matrix.os == 'Windows'
      run: refreshenv

    - name: Configure CMake
      run: cmake --preset ${{matrix.preset}}

    - name: Run CppCheck
      run: python tools/cppcheck.py --build-dir=build/${{matrix.preset}} --show-code
